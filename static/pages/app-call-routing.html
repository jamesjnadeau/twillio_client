<link rel="import" href="/vendor/firebase-element/firebase-element.html">
<link rel="import" href="/vendor/paper-shadow/paper-shadow.html">
<link rel="import" href="/vendor/paper-input/paper-input.html">
<link rel="import" href="/vendor/paper-fab/paper-fab.html">

<link rel="import" href="/components/app-globals.html">
<link rel="import" href="/components/call-router.html">

<polymer-element name="app-call-routing" attributes="auth routingid" >
	<template>
		<link rel='stylesheet' href='/css/default.css'/>
		<app-globals id="globals" firebase_url="{{firebase_url}}" colors="{{colors}}" ></app-globals>
			<div hidden?="{{routers.length}}">
				<paper-shadow  z="1" class="card">
					<h3>Add a route with the button below</h3>
				</paper-shadow>
			</div>
			<template repeat="{{ router in routers }}">
				<call-router router_uid={{router}}></call-router>
			</template>
			<div layout horizontal >
				<span flex></span>
				<paper-fab icon="add" style="background-color: {{colors.primary}};" on-tap="{{addRouter}}"></paper-fab>
				<span flex></span>
			</div>
	</template>
 	<script>
		(function() {
			var login_saved = false;
			Polymer({
				ready: function() {
					
					this.routers = []
					this.firebase_data_url = this.firebase_url+'/routers/';
					console.log(this.firebase_data_url)

					this.resetLocal = function() {
						// direct setting of data is persisted automatically
						this.data = {
							name: 'anonymous',
							info: 'none',
							more: {
								color: "yellow"
							}
						};
					};

					this.removeLocal = function() {
						this.data = null;
					};
				},
				domReady: function() {
					//console.log('data',this.data);
					var self = this;
					var firebaseRouters = new Firebase(this.firebase_data_url)
					var user_uid = this.auth.user.uid;
					console.log('user_uid', user_uid);
					/*
							var newRouter = firebaseRouters.push({ user_uid: user_uid });
							var uid = newRouter.key();
							self.routers.push({uid:newRouter.key()});
					*/
					var myFirebaseRouters = firebaseRouters.orderByChild("user_uid").equalTo(user_uid);
					myFirebaseRouters.on('child_added', function(snapshot) {
						self.routers.push(snapshot.key())
					});
					myFirebaseRouters.on('child_removed', function(snapshot) {
						console.log('child_removed', snapshot.key());
						for(var i = 0; i < self.routers.length; i++) {
							if(self.routers[i] == snapshot.key()) {
								self.routers.splice(i, 1);
								break;
							}
						}
					});
					
				},
				addRouter: function() {
					var firebaseRouters = new Firebase(this.firebase_data_url)
					var user_uid = this.auth.user.uid;
					var newRouter = firebaseRouters.push({ user_uid: user_uid });
					var uid = newRouter.key();
					self.routers.push({uid:newRouter.key()});
				}
			});
		})();
	</script>
</polymer-element>
  